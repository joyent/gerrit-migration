{"project":"joyent/smartos-live","branch":"master","id":"I3c1aa42777928dc08c97839aefbb5fbbad7f0228","number":"4820","subject":"OS-7182 vmadm can create/destroy/rollback bhyve VM snapshots Reviewed by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e Reviewed by: Pedro Palaz贸n Candel \u003cpedro@joyent.com\u003e Approved by: Josh Wilsdon \u003cjosh@wilsdon.ca\u003e Approved by: Pedro Palaz贸n Candel \u003cpedro@joyent","owner":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"url":"https://cr.joyent.us/4820","commitMessage":"OS-7182 vmadm can create/destroy/rollback bhyve VM snapshots\nReviewed by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e\nReviewed by: Pedro Palaz贸n Candel \u003cpedro@joyent.com\u003e\nApproved by: Josh Wilsdon \u003cjosh@wilsdon.ca\u003e\nApproved by: Pedro Palaz贸n Candel \u003cpedro@joyent.com\u003e\n","createdOn":1536680155,"lastUpdated":1542393894,"open":false,"status":"MERGED","comments":[{"timestamp":1536680155,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Uploaded patch set 1."},{"timestamp":1536680155,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit a928183660bff9202859128bb7a1b83f6b5b0c49\n    \n    fix should be in different ticket\n    \n    commit 1e12d867cc670dd4d60534e02967c2624243588e\n    \n    more style fixes\n    \n    commit 75917d9a021d673f4b2943c5c0a9c6d7582c0840\n    \n    linting fixes\n    \n    commit a705c87c1f37473d86a735ec4cdbc1c2141c9b63\n    \n    remove tmp bhyve tests\n    \n    commit 70c4c7669873932be583cf7c6f6d6f555689ca19\n    \n    bhyve snapshots should be mounted on statechange\n    \n    commit bca2db0346dddf903706bcc139b182dfd7a27f03\n    \n    refactoring\n    \n    commit 0ea91190de4b558a172480904b56fb34c4f15ae1\n    \n    bhyve snapshots working"},{"timestamp":1536680201,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1536680294,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Uploaded patch set 2: Patch Set 1 was rebased."},{"timestamp":1536680295,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit 7d764bf138598a031a2f953af7eb3fcf03122a04\n    \n    fix should be in different ticket\n    \n    commit 126c1e5350bc4609e3990e51088e3d47284f2dfa\n    \n    more style fixes\n    \n    commit 7e66a2cbcd6cf1424a90ebd679c3aa9360be15d4\n    \n    linting fixes\n    \n    commit 9fb673582571faef0474ae9dcf6801d71b6c2b2f\n    \n    remove tmp bhyve tests\n    \n    commit 8d84934c41355b0d2c38d39cc03a5bd2e8ec4dd5\n    \n    bhyve snapshots should be mounted on statechange\n    \n    commit f0842495d3eed8a06b1ce7bb1dd258773dd44faa\n    \n    refactoring\n    \n    commit f7975fc8aead9ba080e815708f6ecddeafb6d46c\n    \n    bhyve snapshots working"},{"timestamp":1536680341,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2:\n\n\"make check\" passed ok"},{"timestamp":1536775824,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Uploaded patch set 3."},{"timestamp":1536775825,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit 93e8e65cae8f0999a0c1f8e502cc4e39d61ebb01\n    \n    Merge branch \u0027OS-7182\u0027 of github.com:joyent/smartos-live into OS-7182\n    \n    commit 9b7c21a504fe0ee001167f56d43a2ac3b20c8aa9\n    \n    update man page\n    \n    commit 632b8b64e7c7410fd005d28369c8840a78a5c450\n    \n    fix should be in different ticket\n    \n    commit 0b67877ec80b4ceceaef35ece20a11300b271b2d\n    \n    more style fixes\n    \n    commit 8fb1f1ad6c5ed5e286b4da62214a87ec0533f115\n    \n    linting fixes\n    \n    commit 2093816bbe76ace109b8ae4ee41734019b5b23a0\n    \n    remove tmp bhyve tests\n    \n    commit 82bdb0e529b5ec4c3ecb7ed2b06514aef8648cc1\n    \n    bhyve snapshots should be mounted on statechange\n    \n    commit 5bce713d13d5b576d7960d7d3bc086cc53f80e06\n    \n    refactoring\n    \n    commit 83d08b3ad6f1fee999fd28c6ea4af7ff22819cf6\n    \n    bhyve snapshots working\n    \n    commit a928183660bff9202859128bb7a1b83f6b5b0c49\n    \n    fix should be in different ticket\n    \n    commit 1e12d867cc670dd4d60534e02967c2624243588e\n    \n    more style fixes\n    \n    commit 75917d9a021d673f4b2943c5c0a9c6d7582c0840\n    \n    linting fixes\n    \n    commit a705c87c1f37473d86a735ec4cdbc1c2141c9b63\n    \n    remove tmp bhyve tests\n    \n    commit 70c4c7669873932be583cf7c6f6d6f555689ca19\n    \n    bhyve snapshots should be mounted on statechange\n    \n    commit bca2db0346dddf903706bcc139b182dfd7a27f03\n    \n    refactoring\n    \n    commit 0ea91190de4b558a172480904b56fb34c4f15ae1\n    \n    bhyve snapshots working"},{"timestamp":1536775871,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1536791385,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 3: Code-Review+1\n\n(6 comments)"},{"timestamp":1537895230,"reviewer":{"name":"Pedro Palaz贸n Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 3: Code-Review+1\n\n(4 comments)\n\nOther than the same indentation concerns Josh already pointed out, LGTM"},{"timestamp":1539904188,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Uploaded patch set 4."},{"timestamp":1539904189,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 4:\n\nNew commits:\n    \n    commit 4f23bccb89838ee96c036895b2926aed13d13218\n    \n    bhyve snapshots working"},{"timestamp":1539904226,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing-1\n\n\"make check\" exited with status 2\n\n /tmp/repo/src/vm/tests/test-vminfod-zpoolwatcher.js\n /tmp/repo/src/vm/lib/metadata/agent.js\n /tmp/repo/src/vm/lib/metadata/common.js\n /tmp/repo/src/vm/lib/metadata/crc32.js\n /tmp/repo/src/disklayout.js\n /tmp/repo/src/mkzpool.js\n /tmp/repo/src/ntp_config.js\n /tmp/repo/src/node_modules/disklayout.js\n \n 0 error(s), 0 warnings(s)\n \n \u003d\u003d\u003e Running jsstyle...\n (for file in filewait.js node_modules/{system,onlyif,net-boot-config}.js net-boot-config vm/sbin/*.js vm/node_modules/diff.js vm/node_modules/dladm.js vm/node_modules/expander.js vm/node_modules/fswatcher.js vm/node_modules/hrtime.js vm/node_modules/ip.js vm/node_modules/nic.js vm/node_modules/proptable.js vm/node_modules/utils.js vm/node_modules/VM.js vm/node_modules/qmp.js vm/node_modules/queue.js vm/node_modules/openonerrlogger.js vm/node_modules/vmload/*.js vm/node_modules/vminfod/*.js vm/node_modules/sysevent-stream.js vm/node_modules/zonecfg.js vm/node_modules/zoneevent.js img/lib/*.js img/sbin/imgadm vm/common/nictag.js vm/tests/common.js vm/tests/test-alias.js vm/tests/test-cleanup-on-failure.js vm/tests/test-create-filesystems.js vm/tests/test-create.js vm/tests/test-defaults.js vm/tests/test-docker.js vm/tests/test-firewall.js vm/tests/test-fswatcher.js vm/tests/test-hrtime.js vm/tests/test-indestructible.js vm/tests/test-internal_metadata_namespaces.js vm/tests/test-lastexited.js vm/tests/test-openonerrlogger.js vm/tests/test-queue.js vm/tests/test-reboot.js vm/tests/test-reprovision.js vm/tests/test-send-recv.js vm/tests/test-snapshots.js vm/tests/test-spoof-opts.js vm/tests/test-sysinfo.js vm/tests/test-tmpfs.js vm/tests/test-update.js vm/tests/test-vrrp-nics.js vm/tests/test-vminfod-zonewatcher.js vm/tests/test-vminfod-zonewatcher-overflow.js vm/tests/test-vminfod-zpoolwatcher.js vm/lib/metadata/*.js; do \\\n \techo /tmp/repo/src/$file; \\\n \t/tmp/repo/src/../tools/jsstyle/jsstyle -o indent\u003d4,strict-indent\u003d1,doxygen,unparenthesized-return\u003d0,continuation-at-front\u003d1,leading-right-paren-ok\u003d1 $file; \\\n \t[[ $? \u003d\u003d \"0\" ]] || exit 1; \\\n done)\n /tmp/repo/src/filewait.js\n /tmp/repo/src/node_modules/system.js\n /tmp/repo/src/node_modules/onlyif.js\n /tmp/repo/src/node_modules/net-boot-config.js\n /tmp/repo/src/net-boot-config\n /tmp/repo/src/vm/sbin/add-userscript.js\n /tmp/repo/src/vm/sbin/metadata.js\n /tmp/repo/src/vm/sbin/vmadm.js\n /tmp/repo/src/vm/sbin/vmadmd.js\n /tmp/repo/src/vm/sbin/vmdf.js\n /tmp/repo/src/vm/sbin/vminfo.js\n /tmp/repo/src/vm/sbin/vminfod.js\n /tmp/repo/src/vm/node_modules/diff.js\n /tmp/repo/src/vm/node_modules/dladm.js\n /tmp/repo/src/vm/node_modules/expander.js\n /tmp/repo/src/vm/node_modules/fswatcher.js\n /tmp/repo/src/vm/node_modules/hrtime.js\n /tmp/repo/src/vm/node_modules/ip.js\n /tmp/repo/src/vm/node_modules/nic.js\n /tmp/repo/src/vm/node_modules/proptable.js\n /tmp/repo/src/vm/node_modules/utils.js\n /tmp/repo/src/vm/node_modules/VM.js\n vm/node_modules/VM.js: 12542: indent by tabs instead of spaces\n vm/node_modules/VM.js: 12543: indent by tabs instead of spaces\n vm/node_modules/VM.js: 12544: indent by tabs instead of spaces\n vm/node_modules/VM.js: 12545: indent by tabs instead of spaces\n vm/node_modules/VM.js: 12546: indent by tabs instead of spaces\n Makefile:458: recipe for target \u0027check\u0027 failed\n make[1]: *** [check] Error 1\n make[1]: Leaving directory \u0027/tmp/repo/src\u0027\n Makefile:379: recipe for target \u0027check\u0027 failed\n gmake: *** [check] Error 2"},{"timestamp":1539904857,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Uploaded patch set 5."},{"timestamp":1539904858,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 5:\n\nNew commits:\n    \n    commit f1f9d883a8f13001b110b07e00068a18cbbb6932\n    \n    formatting"},{"timestamp":1539904895,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing-1\n\n\"make check\" exited with status 2\n\n /tmp/repo/src/vm/tests/test-vminfod-zpoolwatcher.js\n /tmp/repo/src/vm/lib/metadata/agent.js\n /tmp/repo/src/vm/lib/metadata/common.js\n /tmp/repo/src/vm/lib/metadata/crc32.js\n /tmp/repo/src/disklayout.js\n /tmp/repo/src/mkzpool.js\n /tmp/repo/src/ntp_config.js\n /tmp/repo/src/node_modules/disklayout.js\n \n 0 error(s), 0 warnings(s)\n \n \u003d\u003d\u003e Running jsstyle...\n (for file in filewait.js node_modules/{system,onlyif,net-boot-config}.js net-boot-config vm/sbin/*.js vm/node_modules/diff.js vm/node_modules/dladm.js vm/node_modules/expander.js vm/node_modules/fswatcher.js vm/node_modules/hrtime.js vm/node_modules/ip.js vm/node_modules/nic.js vm/node_modules/proptable.js vm/node_modules/utils.js vm/node_modules/VM.js vm/node_modules/qmp.js vm/node_modules/queue.js vm/node_modules/openonerrlogger.js vm/node_modules/vmload/*.js vm/node_modules/vminfod/*.js vm/node_modules/sysevent-stream.js vm/node_modules/zonecfg.js vm/node_modules/zoneevent.js img/lib/*.js img/sbin/imgadm vm/common/nictag.js vm/tests/common.js vm/tests/test-alias.js vm/tests/test-cleanup-on-failure.js vm/tests/test-create-filesystems.js vm/tests/test-create.js vm/tests/test-defaults.js vm/tests/test-docker.js vm/tests/test-firewall.js vm/tests/test-fswatcher.js vm/tests/test-hrtime.js vm/tests/test-indestructible.js vm/tests/test-internal_metadata_namespaces.js vm/tests/test-lastexited.js vm/tests/test-openonerrlogger.js vm/tests/test-queue.js vm/tests/test-reboot.js vm/tests/test-reprovision.js vm/tests/test-send-recv.js vm/tests/test-snapshots.js vm/tests/test-spoof-opts.js vm/tests/test-sysinfo.js vm/tests/test-tmpfs.js vm/tests/test-update.js vm/tests/test-vrrp-nics.js vm/tests/test-vminfod-zonewatcher.js vm/tests/test-vminfod-zonewatcher-overflow.js vm/tests/test-vminfod-zpoolwatcher.js vm/lib/metadata/*.js; do \\\n \techo /tmp/repo/src/$file; \\\n \t/tmp/repo/src/../tools/jsstyle/jsstyle -o indent\u003d4,strict-indent\u003d1,doxygen,unparenthesized-return\u003d0,continuation-at-front\u003d1,leading-right-paren-ok\u003d1 $file; \\\n \t[[ $? \u003d\u003d \"0\" ]] || exit 1; \\\n done)\n /tmp/repo/src/filewait.js\n /tmp/repo/src/node_modules/system.js\n /tmp/repo/src/node_modules/onlyif.js\n /tmp/repo/src/node_modules/net-boot-config.js\n /tmp/repo/src/net-boot-config\n /tmp/repo/src/vm/sbin/add-userscript.js\n /tmp/repo/src/vm/sbin/metadata.js\n /tmp/repo/src/vm/sbin/vmadm.js\n /tmp/repo/src/vm/sbin/vmadmd.js\n /tmp/repo/src/vm/sbin/vmdf.js\n /tmp/repo/src/vm/sbin/vminfo.js\n /tmp/repo/src/vm/sbin/vminfod.js\n /tmp/repo/src/vm/node_modules/diff.js\n /tmp/repo/src/vm/node_modules/dladm.js\n /tmp/repo/src/vm/node_modules/expander.js\n /tmp/repo/src/vm/node_modules/fswatcher.js\n /tmp/repo/src/vm/node_modules/hrtime.js\n /tmp/repo/src/vm/node_modules/ip.js\n /tmp/repo/src/vm/node_modules/nic.js\n /tmp/repo/src/vm/node_modules/proptable.js\n /tmp/repo/src/vm/node_modules/utils.js\n /tmp/repo/src/vm/node_modules/VM.js\n vm/node_modules/VM.js: 12542: indent by tabs instead of spaces\n vm/node_modules/VM.js: 12543: indent by tabs instead of spaces\n vm/node_modules/VM.js: 12544: indent by tabs instead of spaces\n vm/node_modules/VM.js: 12545: indent by tabs instead of spaces\n vm/node_modules/VM.js: 12546: indent by tabs instead of spaces\n Makefile:458: recipe for target \u0027check\u0027 failed\n make[1]: *** [check] Error 1\n make[1]: Leaving directory \u0027/tmp/repo/src\u0027\n Makefile:379: recipe for target \u0027check\u0027 failed\n gmake: *** [check] Error 2"},{"timestamp":1539917058,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 5:\n\n(7 comments)\n\nI have no idea what\u0027s happening with make check. The code should be fine to review though."},{"timestamp":1539917151,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 5:\n\nOops realized make check failed"},{"timestamp":1539917286,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Uploaded patch set 6."},{"timestamp":1539917287,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 6:\n\nNew commits:\n    \n    commit 6bcc4c84b30808b75ab2cdaf3630444e3829e3ce\n    \n    fix spaces"},{"timestamp":1539917333,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1539957261,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 6:\n\n(3 comments)"},{"timestamp":1539961450,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Uploaded patch set 7."},{"timestamp":1539961451,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 7:\n\nNew commits:\n    \n    commit 70032a8d6802c9113feee061f0ceed2a801c2ad5\n    \n    respond to cr"},{"timestamp":1539961483,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 7:\n\n(3 comments)"},{"timestamp":1539961497,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 7: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1539961614,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Uploaded patch set 8."},{"timestamp":1539961615,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 8:\n\nNew commits:\n    \n    commit 87e4d1dac3b9ff0525a76c4c040b9d3f66683ddd\n    \n    accidentally committed a file"},{"timestamp":1539961660,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 8: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1539961862,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 8:\n\nOnce the statechange file is removed this will have my +1."},{"timestamp":1539962037,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Uploaded patch set 9."},{"timestamp":1539962038,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 9:\n\nNew commits:\n    \n    commit 4283374978d1b7320ef52ef26d5a8dbeb08c0679\n    \n    remove bhyve overlay"},{"timestamp":1539962072,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 9: Code-Review+1"},{"timestamp":1539962083,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 9: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1540214768,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 9: -Code-Review\n\nPulled +1 after reconsidering mounting of bhyve snapshots.  Since the mounts under \u003czoneroot\u003e/checkpoints/ could only ever be read by the bhyve process and it would never do that, we shouldn\u0027t even mount the snapshots for bhyve.  More verbosely: https://chat.joyent.us/joyent/pl/kbgnfqqnpfgpzj53ei1qy55zco"},{"timestamp":1540230358,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Uploaded patch set 10."},{"timestamp":1540230360,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 10:\n\nNew commits:\n    \n    commit 5217f6ff30847f825d1f392155581df59e4901c8\n    \n    do not mount/umount bhyve snapshots\n    \n    commit bb30afdcb9e9071243272c28769df1fbfad090e8\n    \n    accidentally dropped a test during the merge"},{"timestamp":1540230406,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 10: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1540245785,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 10:\n\n(2 comments)"},{"timestamp":1540251782,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 10:\n\n(1 comment)"},{"timestamp":1540269669,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 10: Code-Review+1\n\n(1 comment)\n\nlgtm. Dylan: can you add notes to the ticket indicating what testing has been done? If that all looks in order I can IA+1 as well assuming that everyone else is ok with leaving anything further with the tests to another ticket (I certainly am)."},{"timestamp":1540298281,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 10: Code-Review+1\n\n(1 comment)"},{"timestamp":1540305724,"reviewer":{"name":"Pedro Palaz贸n Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 10: Code-Review+1\n\nCode looks good to me, waiting on tests results for IA+1.\n\nBtw, and this is not related to this issue, since Dylan is following an already stablished pattern, is there any reason we\u0027re systematically not adding any name to the functions invoked by pipelines, for example?. Apart of a good way of documenting the intention of such functions, it\u0027s definitely helpful when debugging issues.\n\nAs far as I know, there isn\u0027t a rule to enforce such names for JSLint, but here is the same rule for ESLint with some explanation regarding recommended usage: https://eslint.org/docs/rules/func-names"},{"timestamp":1542063138,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Uploaded patch set 11."},{"timestamp":1542063139,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 11:\n\nNew commits:\n    \n    commit cd649d4999d0736fc9e07432a343be6fdd6cd2cc\n    \n    flexible disk size attr added to test\n    \n    commit 2d17ca2862e18a1b29a00693c4c2671545387d83\n    \n    add flex disk attr for test\n    \n    commit 236b78ec41ebf5e5a1e45991919c656442b95eb9\n    \n    do not mount/umount bhyve snapshots\n    \n    commit 3125b55239c6af697fa8d41a0ef8ef1b8e0e1cac\n    \n    accidentally dropped a test during the merge\n    \n    commit 4299c6d8e170a78e2b47067c3d11c485a78a43b2\n    \n    remove bhyve overlay\n    \n    commit 8d98eb206c4dfc95e085bd0a054c689554fc6add\n    \n    accidentally committed a file\n    \n    commit d1edf59c969905f1c811ceb9e3947c2cefb6001f\n    \n    respond to cr\n    \n    commit 5f68c7d03e2152b68784316e05554a99b4486613\n    \n    fix spaces\n    \n    commit 5a9c73f1ca53735b89faae36220e77970cd0f053\n    \n    formatting\n    \n    commit 163fe6a6c49a52fa97b50efe822fc9aeef4a0a90\n    \n    bhyve snapshots working"},{"timestamp":1542063187,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 11: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1542079714,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 11:\n\n(1 comment)"},{"timestamp":1542087813,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Uploaded patch set 12."},{"timestamp":1542087814,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 12:\n\nNew commits:\n    \n    commit ecae862776fe29290549de4e5e7b8746da3ca69b\n    \n    decrease bhyve vm size in test"},{"timestamp":1542087853,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 12:\n\n(1 comment)"},{"timestamp":1542087863,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 12: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1542115556,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 12: Code-Review+1"},{"timestamp":1542120211,"reviewer":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},"message":"Patch Set 12:\n\nGeneric question: Is it possible to optionally exclude a disk from the snapshot? Say a bhyve vm with 2 disks, one is OS one is DATA, so only the OS gets rolled back? \n\nFrom what I can tell, currently that is a no. But maybe worth a follow-up somewhere down the road."},{"timestamp":1542127754,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 12:\n\n@sjorge: Selecting specific disk(s) is something we are considering as a future improvement."},{"timestamp":1542350159,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 12: Integration-Approval+1\n\nThanks! "},{"timestamp":1542384917,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Uploaded patch set 13."},{"timestamp":1542384917,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 13:\n\nNew commits:\n    \n    commit 9398914ddd09791d860bee4652dbe1d11b556a56\n    \n    decrease bhyve vm size in test\n    \n    commit 708d55181f9884d28713e31e68276b4bfa6fd56c\n    \n    flexible disk size attr added to test\n    \n    commit f3f50dcef58495c5ec56483c6600874c9405f13c\n    \n    add flex disk attr for test\n    \n    commit 74063e203470f21f943d5cea09609b56abb7db38\n    \n    do not mount/umount bhyve snapshots\n    \n    commit 7a3f1012caeed1a63117701c900445e25a9a813f\n    \n    accidentally dropped a test during the merge\n    \n    commit 152846872c252c92d5f53b70be50abd6d93ec330\n    \n    remove bhyve overlay\n    \n    commit 3562439eab86d134d53a27679215973ba1fecf02\n    \n    accidentally committed a file\n    \n    commit f63deef51afdb8e6de13459dcf86e6c3199c5145\n    \n    respond to cr\n    \n    commit 7e9899509e9ec7bdaec7e514082b3e53932c66fe\n    \n    fix spaces\n    \n    commit 9f6cd0d210c7514ae9e4210933d6e9c71a7f3434\n    \n    formatting\n    \n    commit 4f4b809a0e6a903bd8775e3dec1c0db73f26111d\n    \n    bhyve snapshots working"},{"timestamp":1542384966,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 13: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1542385364,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 13: Integration-Approval+1"},{"timestamp":1542385777,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 13: Code-Review+1"},{"timestamp":1542391222,"reviewer":{"name":"Pedro Palaz贸n Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 13: Code-Review+1 Integration-Approval+1"},{"timestamp":1542391351,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Uploaded patch set 14."},{"timestamp":1542391352,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 14:\n\nNew commits:\n    \n    commit d3b5de636ffa7f9f3e266942ded051eefb229990\n    \n    decrease bhyve vm size in test\n    \n    commit b2f0e7aa7c10f0e9e3a4aa689a55c2eb4560a98f\n    \n    flexible disk size attr added to test\n    \n    commit 2e71e98c755dc38712ae01c25c6af8a5dff06a24\n    \n    add flex disk attr for test\n    \n    commit 36b70851776367edeb2568ce0286c7f6d1c403d6\n    \n    do not mount/umount bhyve snapshots\n    \n    commit 5707e5249ae277447d47a6f88774a8473ff03206\n    \n    accidentally dropped a test during the merge\n    \n    commit f221cd3b453f9f58dd68305b96600834ee5385c0\n    \n    remove bhyve overlay\n    \n    commit 103ec0d4804abad72aea4436f96c2de181bc21d7\n    \n    accidentally committed a file\n    \n    commit 3d581d2b03a4f38e3bbcb7e1b4f50469bc405fca\n    \n    respond to cr\n    \n    commit 55e2fb1775baec668867664e7246dcc1597cadba\n    \n    fix spaces\n    \n    commit b43d3ece070833962a2f884aedc8ab5cdc9ebfa3\n    \n    formatting\n    \n    commit dee3b96944ccb71a1f90bc8bf6915364a1325f9e\n    \n    bhyve snapshots working"},{"timestamp":1542391402,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 14: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1542393264,"reviewer":{"name":"Pedro Palaz贸n Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 14: Code-Review+1 Integration-Approval+1"},{"timestamp":1542393894,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Dylan Yep"}],"currentPatchSet":{"number":"14","revision":"3c1aa42777928dc08c97839aefbb5fbbad7f0228","parents":["f6f6b0466549de4784d1f9e50d899fd6ac02294e"],"ref":"refs/changes/20/4820/14","uploader":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"createdOn":1542391351,"author":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1542391402,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1542393264,"by":{"name":"Pedro Palaz贸n Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1542393264,"by":{"name":"Pedro Palaz贸n Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"SUBM","value":"1","grantedOn":1542393894,"by":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"src/vm/man/vmadm.1m.md","type":"MODIFIED","insertions":14,"deletions":-13},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":105,"deletions":-47},{"file":"src/vm/node_modules/vminfod/client.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"src/vm/tests/test-snapshots.js","type":"MODIFIED","insertions":365,"deletions":-9}],"sizeInsertions":486,"sizeDeletions":-71},"patchSets":[{"number":"1","revision":"9d32c1aa7e6374f134608315c257122583e393a1","parents":["a18f2cf619ddb601cadb4bba0ec9075d7bdc966e"],"ref":"refs/changes/20/4820/1","uploader":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"createdOn":1536680155,"author":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1536680201,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"overlay/generic/manifest","type":"MODIFIED","insertions":2,"deletions":0},{"file":"overlay/generic/usr/lib/brand/bhyve/statechange","type":"ADDED","insertions":25,"deletions":0},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":84,"deletions":-46},{"file":"src/vm/tests/test-snapshots.js","type":"MODIFIED","insertions":295,"deletions":-4}],"sizeInsertions":406,"sizeDeletions":-50},{"number":"2","revision":"f3d3890e73556a6f1dbd90023f5aa02578742439","parents":["53a5d0cc5a2cf0fe529d34bd5c00d61b3047b87c"],"ref":"refs/changes/20/4820/2","uploader":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"createdOn":1536680294,"author":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1536680201,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"overlay/generic/manifest","type":"MODIFIED","insertions":2,"deletions":0},{"file":"overlay/generic/usr/lib/brand/bhyve/statechange","type":"ADDED","insertions":25,"deletions":0},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":84,"deletions":-46},{"file":"src/vm/tests/test-snapshots.js","type":"MODIFIED","insertions":295,"deletions":-4}],"sizeInsertions":406,"sizeDeletions":-50},{"number":"3","revision":"608350ffc5e686c06c493e5b1a5d549fea6c454c","parents":["8aa883ddc180eeb09ec9ec558c9ce73e0d779bd4"],"ref":"refs/changes/20/4820/3","uploader":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"createdOn":1536775824,"author":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1536775871,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1536791385,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1537895230,"by":{"name":"Pedro Palaz贸n Candel","email":"pedro@joyent.com","username":"kusor"}}],"comments":[{"file":"src/vm/man/vmadm.1m.md","line":487,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"In the case of bhyve we have datasets other than the zoneroot dataset, since we have the disks. Perhaps \"or any datasets other than the zoneroot dataset and its dependent datasets?\""},{"file":"src/vm/man/vmadm.1m.md","line":487,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Done"},{"file":"src/vm/man/vmadm.1m.md","line":1802,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"For bhyve we\u0027re restoring the disks too, right? Not just the root dataset."},{"file":"src/vm/man/vmadm.1m.md","line":1802,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Yes. Changed wording to make that clear."},{"file":"src/vm/node_modules/VM.js","line":11534,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Is there value in duplicating this here when this has already been done at L11528?"},{"file":"src/vm/node_modules/VM.js","line":11534,"reviewer":{"name":"Pedro Palaz贸n Candel","email":"pedro@joyent.com","username":"kusor"},"message":"+1 on this."},{"file":"src/vm/node_modules/VM.js","line":11534,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Done"},{"file":"src/vm/node_modules/VM.js","line":11556,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"the indentation here I found confusing (might just be gerrit)"},{"file":"src/vm/node_modules/VM.js","line":11556,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Done"},{"file":"src/vm/node_modules/VM.js","line":11571,"reviewer":{"name":"Pedro Palaz贸n Candel","email":"pedro@joyent.com","username":"kusor"},"message":"I concur with Josh regarding indentation. I\u0027d prefer to have some indentation here even at the cost that we\u0027re also closing the parentheses with that extra indentation. More clear, IMO"},{"file":"src/vm/node_modules/VM.js","line":11571,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Done"},{"file":"src/vm/node_modules/VM.js","line":11584,"reviewer":{"name":"Pedro Palaz贸n Candel","email":"pedro@joyent.com","username":"kusor"},"message":"And the same indentation thing"},{"file":"src/vm/node_modules/VM.js","line":11584,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Done"},{"file":"src/vm/node_modules/VM.js","line":11592,"reviewer":{"name":"Pedro Palaz贸n Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Geez! these options should be documented somewhere!"},{"file":"src/vm/tests/test-snapshots.js","line":170,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"nice catch!"},{"file":"src/vm/tests/test-snapshots.js","line":1189,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"The common case I believe with bhyve is still 2 disks. So it might be good to test with such a configuration. To ensure that both disks get snapshotted and rolled back.\n\nIdeally I think we\u0027d come up with some way to verify that the data on both volumes was rolled back. The only way I can think to do that though is with a user-script and mdata-put. Even just having a user-script that wrote to a file on each volume (changing on each boot if the file exists), after doing an mdata-put of those values... Then the test could reboot, to ensure the value changed, then rollback to ensure the old value was returned.\n\nMaybe that\u0027s overkill here though? I don\u0027t know."},{"file":"src/vm/tests/test-snapshots.js","line":1189,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"overlay/generic/manifest","type":"MODIFIED","insertions":2,"deletions":0},{"file":"overlay/generic/usr/lib/brand/bhyve/statechange","type":"ADDED","insertions":25,"deletions":0},{"file":"src/vm/man/vmadm.1m.md","type":"MODIFIED","insertions":13,"deletions":-13},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":84,"deletions":-46},{"file":"src/vm/tests/test-snapshots.js","type":"MODIFIED","insertions":295,"deletions":-4}],"sizeInsertions":419,"sizeDeletions":-63},{"number":"4","revision":"f6d99cc02e0df04376ac14f5499c43329edb3c69","parents":["f85405d733dd4f1cf05879eab3b852ce81eab3ea"],"ref":"refs/changes/20/4820/4","uploader":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"createdOn":1539904188,"author":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1539904226,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"overlay/generic/manifest","type":"MODIFIED","insertions":2,"deletions":0},{"file":"overlay/generic/usr/lib/brand/bhyve/statechange","type":"ADDED","insertions":25,"deletions":0},{"file":"src/vm/man/vmadm.1m.md","type":"MODIFIED","insertions":14,"deletions":-13},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":90,"deletions":-49},{"file":"src/vm/node_modules/vminfod/client.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"src/vm/tests/test-snapshots.js","type":"MODIFIED","insertions":436,"deletions":-38}],"sizeInsertions":569,"sizeDeletions":-102},{"number":"5","revision":"f8d641dea06b004a51ebf2c561489a9e7fe2937d","parents":["f85405d733dd4f1cf05879eab3b852ce81eab3ea"],"ref":"refs/changes/20/4820/5","uploader":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"createdOn":1539904857,"author":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1539904895,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"overlay/generic/manifest","type":"MODIFIED","insertions":2,"deletions":0},{"file":"overlay/generic/usr/lib/brand/bhyve/statechange","type":"ADDED","insertions":25,"deletions":0},{"file":"src/vm/man/vmadm.1m.md","type":"MODIFIED","insertions":14,"deletions":-13},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":90,"deletions":-49},{"file":"src/vm/node_modules/vminfod/client.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"src/vm/tests/test-snapshots.js","type":"MODIFIED","insertions":436,"deletions":-38}],"sizeInsertions":569,"sizeDeletions":-102},{"number":"6","revision":"0bb9385f3f0932605bdaa7c4c560190ab9eb5caa","parents":["f85405d733dd4f1cf05879eab3b852ce81eab3ea"],"ref":"refs/changes/20/4820/6","uploader":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"createdOn":1539917286,"author":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1539917333,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"overlay/generic/manifest","line":121,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Not needed.  The statechange file in illumos-joyent should be modified instead."},{"file":"overlay/generic/manifest","line":121,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Done"},{"file":"overlay/generic/usr/lib/brand/bhyve/statechange","line":1,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"This file already exists in the illumos-joyent repo as usr/src/lib/brand/bhyve/zone/statechange"},{"file":"overlay/generic/usr/lib/brand/bhyve/statechange","line":1,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"I\u0027ll open an illumos-joyent PR shortly"},{"file":"src/vm/node_modules/VM.js","line":12499,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"regexp is unnecessarily expensive.  The following should work at a lower cost.\n\nreturn snapshot.split(\"@vmsnap-\")[1] \u003d\u003d\u003d snapname"},{"file":"src/vm/node_modules/VM.js","line":12499,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"overlay/generic/manifest","type":"MODIFIED","insertions":2,"deletions":0},{"file":"overlay/generic/usr/lib/brand/bhyve/statechange","type":"ADDED","insertions":25,"deletions":0},{"file":"src/vm/man/vmadm.1m.md","type":"MODIFIED","insertions":14,"deletions":-13},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":88,"deletions":-47},{"file":"src/vm/node_modules/vminfod/client.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"src/vm/tests/test-snapshots.js","type":"MODIFIED","insertions":436,"deletions":-38}],"sizeInsertions":567,"sizeDeletions":-100},{"number":"7","revision":"51544d7932d0df93f9ba15a1ba50c444397c5814","parents":["f85405d733dd4f1cf05879eab3b852ce81eab3ea"],"ref":"refs/changes/20/4820/7","uploader":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"createdOn":1539961450,"author":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1539961497,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"overlay/generic/usr/lib/brand/bhyve/statechange","type":"ADDED","insertions":25,"deletions":0},{"file":"src/vm/man/vmadm.1m.md","type":"MODIFIED","insertions":14,"deletions":-13},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":87,"deletions":-47},{"file":"src/vm/node_modules/thing.js","type":"ADDED","insertions":17435,"deletions":0},{"file":"src/vm/node_modules/vminfod/client.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"src/vm/tests/test-snapshots.js","type":"MODIFIED","insertions":364,"deletions":-35}],"sizeInsertions":17927,"sizeDeletions":-97},{"number":"8","revision":"ee844c561f45cffdbf5d4d1e837fb945ee7dfead","parents":["f85405d733dd4f1cf05879eab3b852ce81eab3ea"],"ref":"refs/changes/20/4820/8","uploader":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"createdOn":1539961614,"author":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1539961660,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"overlay/generic/usr/lib/brand/bhyve/statechange","type":"ADDED","insertions":25,"deletions":0},{"file":"src/vm/man/vmadm.1m.md","type":"MODIFIED","insertions":14,"deletions":-13},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":87,"deletions":-47},{"file":"src/vm/node_modules/vminfod/client.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"src/vm/tests/test-snapshots.js","type":"MODIFIED","insertions":364,"deletions":-35}],"sizeInsertions":492,"sizeDeletions":-97},{"number":"9","revision":"2b5ca0694d0440862ad2024d3f38e3f755bd19ba","parents":["f85405d733dd4f1cf05879eab3b852ce81eab3ea"],"ref":"refs/changes/20/4820/9","uploader":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"createdOn":1539962037,"author":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1539962083,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/vm/man/vmadm.1m.md","type":"MODIFIED","insertions":14,"deletions":-13},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":87,"deletions":-47},{"file":"src/vm/node_modules/vminfod/client.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"src/vm/tests/test-snapshots.js","type":"MODIFIED","insertions":364,"deletions":-35}],"sizeInsertions":467,"sizeDeletions":-97},{"number":"10","revision":"92790d19dc4c2c42c519300910fd911235be3501","parents":["f85405d733dd4f1cf05879eab3b852ce81eab3ea"],"ref":"refs/changes/20/4820/10","uploader":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"createdOn":1540230358,"author":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1540230406,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1540269669,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1540305724,"by":{"name":"Pedro Palaz贸n Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1540298281,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"comments":[{"file":"src/vm/node_modules/VM.js","line":12668,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"why not do the check closer to where we check for kvm?  Same goes for the other similar changes in this round."},{"file":"src/vm/node_modules/VM.js","line":12668,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"I think the reason (Dylan correct me if I\u0027m wrong) is that we\u0027re adding support here for bhyve snapshots. But the checks for KVM are all about rejecting the command altogether. \n\nHere we\u0027re just skipping the umount and the rmdir and the other mucking around inside the VM\u0027s datasets from the GZ. Which we can\u0027t do for bhyve."},{"file":"src/vm/node_modules/VM.js","line":12668,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Yeah, got it.  I misread this."},{"file":"src/vm/tests/test-snapshots.js","line":1312,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"This sync is happening in the guest and does not necessarily cause a sync(2).  At best, it is calling fsync(2) on the zvols that have the guest\u0027s disk(s).  This could cause a change in timing that results int more success.\n\nCritically, it does not call vfs_sync on zones/$uuid or fsync on /zones/$uuid/config/metadata.json.\n\nThe test failures you described could be attributed to:\n\n1. Old data in metadata.js: directory content not cached after rename()\n\n2. Empty metadata.js:  writes were reordered. rename() made it to disk but the write to metadata.js.new was not written to disk.\n\n3. No metadata.js: I don\u0027t have an explanation for this, if a write related to a rename() fails, it should give you the old or the new file - losing it is not POSIX compliant.\n\nMaybe a proper fix for the underlying problem is better.  In VM.js, writeAndRename() should open the temp file, write data to it, then:\n\nfs.fsync(tmpfilefd)\nfs.rename()\nfs.open(dirname, \"r\")\nfs.fsync(dirfd)\nfs.close(dirfd)\n\n\nOne thing that a proper fix must not do is call sync(1) or sync(2).  That will cause all cached data for all file systems to be written out.  That can be very expensive to do at the rate that can be induced by mdata-put."},{"file":"src/vm/tests/test-snapshots.js","line":1312,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Dylan clarified by chat that the files that were not correct were the guest files.  Thus, the sync in the guest is correct."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/vm/man/vmadm.1m.md","type":"MODIFIED","insertions":14,"deletions":-13},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":103,"deletions":-47},{"file":"src/vm/node_modules/vminfod/client.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"src/vm/tests/test-snapshots.js","type":"MODIFIED","insertions":365,"deletions":-9}],"sizeInsertions":484,"sizeDeletions":-71},{"number":"11","revision":"6e9ebe60f43be27796fef71b63ff97d49c483530","parents":["d4982e056e750e83e4d44e94c41395c75a07b766"],"ref":"refs/changes/20/4820/11","uploader":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"createdOn":1542063138,"author":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1542063187,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"src/vm/tests/test-snapshots.js","line":1281,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"I suspect that this can be set down to about 15350 (or even a bit smaller if disks[1] is shrunk to 512), which may help it pass on CoaL when there\u0027s already another VM and a few images present."},{"file":"src/vm/tests/test-snapshots.js","line":1281,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"src/vm/man/vmadm.1m.md","type":"MODIFIED","insertions":14,"deletions":-13},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":105,"deletions":-47},{"file":"src/vm/node_modules/vminfod/client.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"src/vm/tests/test-snapshots.js","type":"MODIFIED","insertions":365,"deletions":-9}],"sizeInsertions":486,"sizeDeletions":-71},{"number":"12","revision":"2e95bce21d3f062805b564ebf1761c0e5ab753a2","parents":["d4982e056e750e83e4d44e94c41395c75a07b766"],"ref":"refs/changes/20/4820/12","uploader":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"createdOn":1542087813,"author":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1542087863,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1542350159,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1542115556,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/vm/man/vmadm.1m.md","type":"MODIFIED","insertions":14,"deletions":-13},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":105,"deletions":-47},{"file":"src/vm/node_modules/vminfod/client.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"src/vm/tests/test-snapshots.js","type":"MODIFIED","insertions":365,"deletions":-9}],"sizeInsertions":486,"sizeDeletions":-71},{"number":"13","revision":"6ce83ee9d4dbef84f432c7aeb0958a98ab4e3369","parents":["87aa89bd1fa57bc910461ca672d3a4b856ed448c"],"ref":"refs/changes/20/4820/13","uploader":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"createdOn":1542384917,"author":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1542384966,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1542385364,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1542391222,"by":{"name":"Pedro Palaz贸n Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1542391222,"by":{"name":"Pedro Palaz贸n Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1542385777,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"src/vm/man/vmadm.1m.md","type":"MODIFIED","insertions":14,"deletions":-13},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":105,"deletions":-47},{"file":"src/vm/node_modules/vminfod/client.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"src/vm/tests/test-snapshots.js","type":"MODIFIED","insertions":365,"deletions":-9}],"sizeInsertions":486,"sizeDeletions":-71},{"number":"14","revision":"3c1aa42777928dc08c97839aefbb5fbbad7f0228","parents":["f6f6b0466549de4784d1f9e50d899fd6ac02294e"],"ref":"refs/changes/20/4820/14","uploader":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"createdOn":1542391351,"author":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1542391402,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1542393264,"by":{"name":"Pedro Palaz贸n Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1542393264,"by":{"name":"Pedro Palaz贸n Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"SUBM","value":"1","grantedOn":1542393894,"by":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"src/vm/man/vmadm.1m.md","type":"MODIFIED","insertions":14,"deletions":-13},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":105,"deletions":-47},{"file":"src/vm/node_modules/vminfod/client.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"src/vm/tests/test-snapshots.js","type":"MODIFIED","insertions":365,"deletions":-9}],"sizeInsertions":486,"sizeDeletions":-71}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},{"name":"Pedro Palaz贸n Candel","email":"pedro@joyent.com","username":"kusor"},{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"}]}