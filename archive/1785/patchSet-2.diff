From b6345d4fb76b9cea7fc6b29f3aff66053dd86aea Mon Sep 17 00:00:00 2001
From: Jason King <jason.king@joyent.com>
Date: Wed, 12 Apr 2017 15:55:59 -0500
Subject: [PATCH] TOOLS-1752 Create tool for creating Triton origin images

---
 .gitignore      |   2 +
 Makefile        |  23 ++++++-
 create-image.sh | 166 ++++++++++++++++++++++++++++++++++++++++++++++++
 data.json       |  16 +++++
 package.json    |   2 +-
 5 files changed, 206 insertions(+), 3 deletions(-)
 create mode 100755 create-image.sh
 create mode 100644 data.json

diff --git a/.gitignore b/.gitignore
index 7e7a84d..f0c6abe 100644
--- a/.gitignore
+++ b/.gitignore
@@ -1,3 +1,5 @@
 /node_modules
 /tmp
 /npm-debug.log
+/npm-0-stamp
+/image-0-stamp
diff --git a/Makefile b/Makefile
index 9c2f1a9..906c587 100644
--- a/Makefile
+++ b/Makefile
@@ -4,10 +4,29 @@
 # Makefile for triton-origin-image
 #
 
+NPM = npm
+CREATE_IMAGE = ./create-image.sh
+CONFIG = ./data.json
+
+# Should this default to /Joyent_Dev/stor/builds/.... ?
+MANTA_PATH =
+
+# -------
 
 #
 # Targets
 #
-.PHONY: all
-all:
+.PHONY: all image
+
+all: npm-0-stamp image-0-stamp
+
+npm-0-stamp:
+	$(NPM) install
+	touch $@
+
+image-0-stamp: npm-0-stamp
+	$(CREATE_IMAGE) -f $(CONFIG) $(MANTA_PATH)
+	touch $@
 
+clean:
+	rm -f npm-0-stamp image-0-stamp
diff --git a/create-image.sh b/create-image.sh
new file mode 100755
index 0000000..58f61d5
--- /dev/null
+++ b/create-image.sh
@@ -0,0 +1,166 @@
+#!/bin/bash
+# vi: expandtab sw=4 ts=4
+
+#
+# This Source Code Form is subject to the terms of the Mozilla Public
+# License, v. 2.0. If a copy of the MPL was not distributed with this
+# file, You can obtain one at http://mozilla.org/MPL/2.0/.
+#
+
+#
+# Copyright 2017, Joyent, Inc.
+#
+
+export PS4='[\D{%FT%TZ}] ${BASH_SOURCE}:${LINENO}: ${FUNCNAME[0]:+${FUNCNAME[0]}(): }'
+if [[ -z "$(echo "$*" | grep -- ' -h ' || true)" ]]; then
+  # Try to avoid xtrace goop when print help/usage output.
+  set -o xtrace
+fi
+
+TOP=$(cd $(dirname $0) > /dev/null; pwd)
+SCRIPT="$(basename $0)"
+
+export PATH="${TOP}/node_modules/triton/bin:${PATH}"
+
+[[ -f "$TOP/package.json" ]] && pkgjson="$TOP/package.json"
+
+function fatal {
+    echo "$SCRIPT: error $1"
+
+    cleanup 1
+}
+
+function cleanup() {
+    local exit_status=${1:-$?}
+
+    if [[ -n "$KEEP_INFRA_ON_FAILURE" ]]; then
+        echo "$0: NOT cleaning up (\$KEEP_INFRA_ON_FAILURE is set)"
+        exit $exit_status
+    fi
+
+    [[ -n "$name" ]] && triton instance rm $name || true
+    [[ -n "$image_uuid" ]] && triton image rm -f ${image_uuid} || true
+
+    exit $exit_status
+}
+
+function usage() {
+    if [[ -n "$1" ]]; then
+        echo "error: $1"
+        echo ""
+    fi
+
+    echo "Usage:"
+    echo "  $SCRIPT [OPTIONS] [MANTA_PATH]"
+    echo ""
+    echo "  -h       Print this help and exit."
+    echo "  -f FILE  Use FILE for configuration."
+    echo "  -p FILE  Use FILE as package.json." 
+    echo ""
+
+    exit 1
+}
+
+while getopts hf:p: opt; do
+    case $opt in
+    h)
+        usage
+        ;;
+    f)
+        [[ -n "$OPTARG" ]] && cfgfile="$OPTARG"
+        ;;
+    p)
+        [[ -n "$OPTARG" ]] && pkgjson="$OPTARG"
+        ;;
+    \?)
+        echo "Invalid flag -${opt}" >&2
+        exit 1
+        ;;
+    esac
+done
+
+shift $(($OPTIND - 1))
+
+[[ -n "$cfgfile" ]] || fatal "No configuration file specified, use '-f FILE'"
+[[ -f "$cfgfile" ]] || fatal "Configuration file $cfgfile not found"
+[[ -f "$pkgjson" ]] || fatal "No package.json file specified, use '-p FILE'"
+[[ -n "$1" ]] && manta_path="$1"
+
+image_name=$(json -f "$cfgfile" name)
+image_version=$(json -f "$pkgjson" version)
+image_url=$(json -f "$pkgjson" homepage)
+image_desc=$(json -f "$cfgfile" desc)
+image_package=$(json -f "$cfgfile" image_package)
+image_origin_uuid=$(json -f "$cfgfile" origin.uuid)
+image_origin_name=$(json -f "$cfgfile" origin.name)
+image_origin_version=$(json -f "$cfgfile" origin.version)
+pkgs="$(json -f "$cfgfile" -e 'this.pkg = this.packages.join(" ")' pkg)"
+
+# Allow some overrides
+image_name=${TRITON_IMAGE_NAME:-${image_name}}
+image_version=${TRITON_IMAGE_VERSION:-${image_version}}
+image_package=${TRITON_IMAGE_PACKAGE:-${image_package}}
+pkgs=${TRITON_IMAGE_PKGS:=${pkgs}}
+
+# Can specify name@version or short id to override as well
+# in which case this won't actually hold a UUID
+image_origin_uuid=${TRITON_IMAGE_ORIGIN:-${image_origin_uuid}}
+
+amt=$(triton package list -H name=$image_package | wc -l)
+[[ $amt -eq 0 ]] && fatal "Cannot find image package $image_package"
+[[ $amt -gt 1 ]] && fatal "Image package $image_package is ambiguous"
+
+# Only validate the UUID, name, and verison agree if the value
+# hasn't been overridden
+if [[ -n "$TRITON_IMAGE_NAME" ]]; then
+    amt=$(triton image list -j \
+        name=$image_origin_name \
+        version=$image_origin_version | \
+        json -c "this.id === '$image_origin_uuid'" | \
+        wc -l)
+    [[ $amt -ne 0 ]] || fatal "Image UUID mismatch with name and version"
+fi
+
+trap cleanup ERR
+
+name=$(printf "triton-origin-proto-%02d\n" $((RANDOM % 100)))
+script="/opt/local/bin/pkgin update"
+script="${script}; /opt/local/bin/pkgin -y in $pkgs"
+script="${script}; touch /.done"
+
+triton instance create -w -n $name \
+    -m "user-script=$script" \
+    $image_origin_uuid $image_package \
+    || fatal "Unable to create prototype instance"
+
+ip=$(triton instance ip $name)
+ssh="ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null "
+ssh="$ssh root@$ip"
+count=0
+
+trap '' ERR
+while (( count < 30 )); do
+    $ssh "[[ -f /.done ]] || exit 42" > /dev/null && break
+
+    rc=$?
+    [[ $rc -ne 42 ]] && fatal "Error during ssh"
+
+    (( count = count + 1 ))
+    sleep 60
+done
+trap cleanup ERR
+
+$ssh "rm /.done"
+
+triton instance stop -w $name || fatal "Error while stopping instance $name"
+
+image_uuid=$(triton image create -jw \
+    -d "$image_desc" \
+    -t '{"smartdc_service": true}' \
+    --homepage "$image_url" \
+    $name ${image_name} ${image_version} | json -g 1.id \
+    || fatal "Unable to create image")
+
+[[ -n "$manta_path" ]] && triton image export ${image_uuid} $manta_path
+
+triton instance rm $name
diff --git a/data.json b/data.json
new file mode 100644
index 0000000..ea21574
--- /dev/null
+++ b/data.json
@@ -0,0 +1,16 @@
+{
+    "name": "triton-origin-multiarch",
+    "desc": "Origin for Triton and Manta images",
+    "origin": {
+        "uuid": "ede31770-e19c-11e5-bb6e-3b7de3cca9ce",
+        "name": "minimal-multiarch-lts",
+        "version": "15.4.1"
+    },
+    "image_package": "g4-highcpu-1G",
+    "packages": [
+        "coreutils",
+        "patch",
+        "curl",
+        "gsed"
+    ]
+}
diff --git a/package.json b/package.json
index 93cc55a..1e3432c 100644
--- a/package.json
+++ b/package.json
@@ -6,7 +6,7 @@
   "private": true,
   "homepage": "https://github.com/joyent/triton-origin-image",
   "dependencies": {
-    "triton": "5.1.1"
+    "triton": "5.2.0"
   },
   "repository": {
     "type": "git",
-- 
2.21.0

