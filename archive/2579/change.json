{"project":"joyent/sdc-cloudapi","branch":"master","id":"Ic2b21416cf7b3c2468c91d267e6de0811c17b367","number":"2579","subject":"PUBAPI-1434: Add plugin that allows an account to only use networks it owns Reviewed by: Pedro P. Candel \u003cpedro@joyent.com\u003e Reviewed by: Angela Fong \u003cangela.fong@joyent.com\u003e","owner":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"url":"https://cr.joyent.us/2579","commitMessage":"PUBAPI-1434: Add plugin that allows an account to only use networks it owns\nReviewed by: Pedro P. Candel \u003cpedro@joyent.com\u003e\nReviewed by: Angela Fong \u003cangela.fong@joyent.com\u003e\n","createdOn":1505472849,"lastUpdated":1506545999,"open":false,"status":"MERGED","comments":[{"timestamp":1505472849,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Uploaded patch set 1."},{"timestamp":1505472879,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1505526486,"reviewer":{"name":"Angela Fong","email":"angela.fong@joyent.com","username":"askfongjojo"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1505602093,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1505639713,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Uploaded patch set 2."},{"timestamp":1505639749,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1505922656,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 2: Code-Review+1\n\n(1 comment)\n\n@Marsell: Code looks good to me. Only gotcha: no tests at all? How hard would be to get at least some brief test case?"},{"timestamp":1505945938,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Patch Set 2:\n\n\u003e @Marsell: Code looks good to me. Only gotcha: no tests at all? How\n \u003e hard would be to get at least some brief test case?\n\nNone of the plugins have any tests, but you\u0027re right. We might as well start here.\n\nDue to how plugins work there won\u0027t be any integration tests, but I\u0027ll add unit tests covering it."},{"timestamp":1505974058,"reviewer":{"name":"Angela Fong","email":"angela.fong@joyent.com","username":"askfongjojo"},"message":"Patch Set 2: Code-Review-1\n\n(1 comment)"},{"timestamp":1505975846,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Patch Set 2:\n\nAngela: That is definitely odd. Do the other plugins in /opt/smartdc/cloudapi/plugins fail to load for you?"},{"timestamp":1505976135,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Patch Set 2:\n\nOh, also, does the plugin work if you use the following mix:\n\nvar assert \u003d require(\u0027/opt/smartdc/cloudapi/node_modules/assert-plus\u0027);\nvar restify \u003d require(\u0027restify\u0027);"},{"timestamp":1506097683,"reviewer":{"name":"Angela Fong","email":"angela.fong@joyent.com","username":"askfongjojo"},"message":"Patch Set 2: Code-Review+1\n\nMy SAPI config was incorrect. Sorry about the confusion. The plugin is working for me after fixing the SAPI metadata."},{"timestamp":1506357692,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 2:\n\n\u003e \u003e @Marsell: Code looks good to me. Only gotcha: no tests at all?\n \u003e How\n \u003e \u003e hard would be to get at least some brief test case?\n \u003e \n \u003e None of the plugins have any tests, but you\u0027re right. We might as\n \u003e well start here.\n \u003e \n \u003e Due to how plugins work there won\u0027t be any integration tests, but\n \u003e I\u0027ll add unit tests covering it.\n\nNote I\u0027m perfectly fine if we add plugin tests as a separate issue, though"},{"timestamp":1506503720,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Uploaded patch set 3."},{"timestamp":1506503751,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1506503803,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Uploaded patch set 4: Patch Set 3 was rebased."},{"timestamp":1506503835,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4:\n\n\"make check\" passed ok"},{"timestamp":1506545856,"reviewer":{"name":"Angela Fong","email":"angela.fong@joyent.com","username":"askfongjojo"},"message":"Patch Set 4: Code-Review+1 Integration-Approval+1\n\nI ran the new tests and merged the commit to my coal to test also the functionalities."},{"timestamp":1506545999,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Marsell Kukuljevic"}],"currentPatchSet":{"number":"4","revision":"c2b21416cf7b3c2468c91d267e6de0811c17b367","parents":["b74c919c43dc7504e3031340728eb2cac9c94d58"],"ref":"refs/changes/79/2579/4","uploader":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"createdOn":1506503803,"author":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1506503751,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1506545856,"by":{"name":"Angela Fong","email":"angela.fong@joyent.com","username":"askfongjojo"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1506545856,"by":{"name":"Angela Fong","email":"angela.fong@joyent.com","username":"askfongjojo"}},{"type":"SUBM","value":"1","grantedOn":1506545999,"by":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/app.js","type":"MODIFIED","insertions":26,"deletions":-7},{"file":"lib/networks.js","type":"MODIFIED","insertions":29,"deletions":-28},{"file":"plugins/filter_owner_networks.js","type":"ADDED","insertions":277,"deletions":0},{"file":"test/plugins/filter_owner_networks.test.js","type":"ADDED","insertions":424,"deletions":0},{"file":"test/runtests","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":757,"sizeDeletions":-36},"patchSets":[{"number":"1","revision":"25019515c9438a04b1d6a4a3dfa755f11b8c3b89","parents":["1c405e141d0362c6d805ec47b6125696c2115fc1"],"ref":"refs/changes/79/2579/1","uploader":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"createdOn":1505472849,"author":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1505472879,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"plugins/filter_owner_networks.js","line":12,"reviewer":{"name":"Angela Fong","email":"angela.fong@joyent.com","username":"askfongjojo"},"message":"Will be good to mention that network pool is not in scope. It is possible that we\u0027ll have network pools created for certain accounts as well. The logic in the plugin will have to be enhanced to support that."},{"file":"plugins/filter_owner_networks.js","line":12,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"The plugin works fine with network pools (e.g. I tested it with COAL\u0027s sdc_nat), albeit it makes the assumption that if a network pool has an owner_uuid, that all networks in that pool (regardless of whether they include the owner\u0027s uuid) are eligible for allocation.\n\nThe comment obviously need to be updated to reflect this."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/app.js","type":"MODIFIED","insertions":17,"deletions":-6},{"file":"lib/networks.js","type":"MODIFIED","insertions":8,"deletions":-7},{"file":"plugins/filter_owner_networks.js","type":"ADDED","insertions":242,"deletions":0}],"sizeInsertions":267,"sizeDeletions":-13},{"number":"2","revision":"89de4818b2f2351c3b94845cb673ad4646f5f0dc","parents":["1c405e141d0362c6d805ec47b6125696c2115fc1"],"ref":"refs/changes/79/2579/2","uploader":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"createdOn":1505639713,"author":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1505639749,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1505922656,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1506097683,"by":{"name":"Angela Fong","email":"angela.fong@joyent.com","username":"askfongjojo"}}],"comments":[{"file":"lib/app.js","line":339,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Good call. Definitely more clear later, when picking up which plugins to load at mount time. I like it."},{"file":"plugins/filter_owner_networks.js","line":47,"reviewer":{"name":"Angela Fong","email":"angela.fong@joyent.com","username":"askfongjojo"},"message":"The full paths to the node_module dir are required here, i.e.\nvar assert \u003d require(\u0027/opt/smartdc/cloudapi/node_modules/assert-plus\u0027);\nvar restify \u003d require(\u0027/opt/smartdc/cloudapi/node_modules/restify\u0027);\n\nWithout the change, I got \"Cannot find module\" error."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/app.js","type":"MODIFIED","insertions":26,"deletions":-7},{"file":"lib/networks.js","type":"MODIFIED","insertions":29,"deletions":-28},{"file":"plugins/filter_owner_networks.js","type":"ADDED","insertions":277,"deletions":0}],"sizeInsertions":332,"sizeDeletions":-35},{"number":"3","revision":"ccfc8c042998c32b5e857a1663465f06a8440abd","parents":["1c405e141d0362c6d805ec47b6125696c2115fc1"],"ref":"refs/changes/79/2579/3","uploader":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"createdOn":1506503720,"author":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1506503751,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/app.js","type":"MODIFIED","insertions":26,"deletions":-7},{"file":"lib/networks.js","type":"MODIFIED","insertions":29,"deletions":-28},{"file":"plugins/filter_owner_networks.js","type":"ADDED","insertions":277,"deletions":0},{"file":"test/plugins/filter_owner_networks.test.js","type":"ADDED","insertions":424,"deletions":0},{"file":"test/runtests","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":757,"sizeDeletions":-36},{"number":"4","revision":"c2b21416cf7b3c2468c91d267e6de0811c17b367","parents":["b74c919c43dc7504e3031340728eb2cac9c94d58"],"ref":"refs/changes/79/2579/4","uploader":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"createdOn":1506503803,"author":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1506503751,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1506545999,"by":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1506545856,"by":{"name":"Angela Fong","email":"angela.fong@joyent.com","username":"askfongjojo"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1506545856,"by":{"name":"Angela Fong","email":"angela.fong@joyent.com","username":"askfongjojo"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/app.js","type":"MODIFIED","insertions":26,"deletions":-7},{"file":"lib/networks.js","type":"MODIFIED","insertions":29,"deletions":-28},{"file":"plugins/filter_owner_networks.js","type":"ADDED","insertions":277,"deletions":0},{"file":"test/plugins/filter_owner_networks.test.js","type":"ADDED","insertions":424,"deletions":0},{"file":"test/runtests","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":757,"sizeDeletions":-36}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},{"name":"Angela Fong","email":"angela.fong@joyent.com","username":"askfongjojo"},{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"}]}