{"project":"joyent/sdcadm","branch":"master","id":"I1b560722698114c8c1080d2cf768112a08cd885d","number":"3289","subject":"TOOLS-1957 sdcadm updateGzTools should limit the number of backups Reviewed by: Trent Mick \u003ctrentm@gmail.com\u003e Approved by: Trent Mick \u003ctrentm@gmail.com\u003e","owner":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"url":"https://cr.joyent.us/3289","commitMessage":"TOOLS-1957 sdcadm updateGzTools should limit the number of backups\nReviewed by: Trent Mick \u003ctrentm@gmail.com\u003e\nApproved by: Trent Mick \u003ctrentm@gmail.com\u003e\n","createdOn":1517519267,"lastUpdated":1518126857,"open":false,"status":"MERGED","comments":[{"timestamp":1517519267,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Uploaded patch set 1."},{"timestamp":1517519311,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1517519774,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Uploaded patch set 2."},{"timestamp":1517519810,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1517590592,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 2:\n\n(2 comments)\n\nMinor thing for conditional check + question about change of backup names."},{"timestamp":1517590652,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 2:\n\nForget such question, I\u0027ve seen it\u0027s suggested as 2nd part of the issue and it\u0027s just a Trent\u0027s preference.\n\n \u003e (2 comments)\n \u003e \n \u003e Minor thing for conditional check + question about change of backup\n \u003e names."},{"timestamp":1518041321,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Uploaded patch set 3."},{"timestamp":1518041364,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1518043687,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1518114226,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1518114239,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Uploaded patch set 4."},{"timestamp":1518114313,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1518114684,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 4: Code-Review+1 Integration-Approval+1"},{"timestamp":1518126849,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Patch Set 5: Commit message was updated."},{"timestamp":1518126857,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Chris Burroughs"}],"currentPatchSet":{"number":"5","revision":"0587a0a0575c2c1e26db8fd60da9c3d26952790d","parents":["fb4cadc9cb9813a986650a758657034a10fc4cc1"],"ref":"refs/changes/89/3289/5","uploader":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"createdOn":1518126849,"author":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1518114313,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1518114684,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1518114684,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1518126857,"by":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/sdcadm.js","type":"MODIFIED","insertions":24,"deletions":-2}],"sizeInsertions":24,"sizeDeletions":-2},"patchSets":[{"number":"1","revision":"f68072170d576bfbbf67a053929f9f2ec3883476","parents":["fb4cadc9cb9813a986650a758657034a10fc4cc1"],"ref":"refs/changes/89/3289/1","uploader":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"createdOn":1517519267,"author":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1517519311,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/sdcadm.js","type":"MODIFIED","insertions":22,"deletions":-1}],"sizeInsertions":22,"sizeDeletions":-1},{"number":"2","revision":"32c83956c39093e4c8c214fb12ca7d435b426e41","parents":["fb4cadc9cb9813a986650a758657034a10fc4cc1"],"ref":"refs/changes/89/3289/2","uploader":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"createdOn":1517519774,"author":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1517519810,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/sdcadm.js","line":1537,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Wouldn\u0027t this be `if (toDelete.length)`. If I\u0027m not on a mistake, slice will always create an array, even if it\u0027s empty."},{"file":"lib/sdcadm.js","line":1552,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"I\u0027m not strongly opposed to the change on the backups name format. May I know the reason, though?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/sdcadm.js","type":"MODIFIED","insertions":23,"deletions":-2}],"sizeInsertions":23,"sizeDeletions":-2},{"number":"3","revision":"a1984fc43a4a5f4ad8d50dc55eec1ea08bef3f2e","parents":["fb4cadc9cb9813a986650a758657034a10fc4cc1"],"ref":"refs/changes/89/3289/3","uploader":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"createdOn":1518041321,"author":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1518041364,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/sdcadm.js","line":1535,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"With some testing, this sort doesn\u0027t work the way we want when there are old and new-named backup files. After a couple \u0027sdcadm ex update-gz-tools ...` runs:\n\n```\n[root@headnode (coal) /usbkey/extra/joysetup]# ls -alt\ntotal 7772\n-rwxr-xr-x   1 root     root        5883 Feb  7 22:40 agentsetup.sh\n-rwxr-xr-x   1 root     root       20894 Feb  7 22:40 joysetup.sh\n-rw-r--r--   1 root     root      638851 Feb  7 22:40 cn_tools.tar.gz\ndrwxr-xr-x   2 root     root          11 Feb  7 22:40 .\n-rw-r--r--   1 root     root      631289 Feb  7 22:39 cn_tools.20180207T224006.tar.gz\n-rw-r--r--   1 root     root      630397 Feb  7 22:36 cn_tools.2018-02-07T22:37:04.393Z.tar.gz\n-rw-r--r--   1 root     root      632127 Feb  7 22:36 cn_tools.2018-02-07T22:36:44.527Z.tar.gz\n-rw-r--r--   1 root     root      639234 Feb  7 22:35 cn_tools.2018-02-07T22:36:27.504Z.tar.gz\ndrwxr-xr-x   4 root     root           4 Feb  2 19:09 ..\n-rw-r--r--   1 root     root         761 Feb  2 19:08 node.config\n-rwxr-xr-x   1 root     root      637721 Feb  2 19:08 cn_tools.2018-02-07T22:35:52.442Z.tar.gz\n[root@headnode (coal) /usbkey/extra/joysetup]# ls -alt\ntotal 7772\n-rwxr-xr-x   1 root     root        5883 Feb  7 22:40 agentsetup.sh\n-rwxr-xr-x   1 root     root       20894 Feb  7 22:40 joysetup.sh\n-rw-r--r--   1 root     root      629484 Feb  7 22:40 cn_tools.tar.gz\ndrwxr-xr-x   2 root     root          11 Feb  7 22:40 .\n-rw-r--r--   1 root     root      638851 Feb  7 22:40 cn_tools.20180207T224059.tar.gz\n-rw-r--r--   1 root     root      630397 Feb  7 22:36 cn_tools.2018-02-07T22:37:04.393Z.tar.gz\n-rw-r--r--   1 root     root      632127 Feb  7 22:36 cn_tools.2018-02-07T22:36:44.527Z.tar.gz\n-rw-r--r--   1 root     root      639234 Feb  7 22:35 cn_tools.2018-02-07T22:36:27.504Z.tar.gz\ndrwxr-xr-x   4 root     root           4 Feb  2 19:09 ..\n-rw-r--r--   1 root     root         761 Feb  2 19:08 node.config\n-rwxr-xr-x   1 root     root      637721 Feb  2 19:08 cn_tools.2018-02-07T22:35:52.442Z.tar.gz\n```\n\nwe are only getting the *last* newly named backup file saved, and 4 of the old named backup files.\n\n\nAh, actually I think the issue is that you want to *reverse* the sorted names:\n\n```\n# wrong\n\u003e tarballs.sort()\n[ \u0027cn_tools.2018-02-07T22:35:52.442Z.tar.gz\u0027,\n  \u0027cn_tools.2018-02-07T22:36:27.504Z.tar.gz\u0027,\n  \u0027cn_tools.2018-02-07T22:36:44.527Z.tar.gz\u0027,\n  \u0027cn_tools.2018-02-07T22:37:04.393Z.tar.gz\u0027,\n  \u0027cn_tools.20180207T224059.tar.gz\u0027 ]\n\u003e tarballs.slice(4)\n[ \u0027cn_tools.20180207T224059.tar.gz\u0027 ]\n\n# correct\n\u003e tarballs.sort().reverse()\n[ \u0027cn_tools.20180207T224059.tar.gz\u0027,\n  \u0027cn_tools.2018-02-07T22:37:04.393Z.tar.gz\u0027,\n  \u0027cn_tools.2018-02-07T22:36:44.527Z.tar.gz\u0027,\n  \u0027cn_tools.2018-02-07T22:36:27.504Z.tar.gz\u0027,\n  \u0027cn_tools.2018-02-07T22:35:52.442Z.tar.gz\u0027 ]\n\u003e tarballs.slice(4)\n[ \u0027cn_tools.2018-02-07T22:35:52.442Z.tar.gz\u0027 ]\n```"},{"file":"lib/sdcadm.js","line":1535,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Yikes, thanks on the reverse.\n\nSee other conversation about testability."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/sdcadm.js","type":"MODIFIED","insertions":23,"deletions":-2}],"sizeInsertions":23,"sizeDeletions":-2},{"number":"4","revision":"1b560722698114c8c1080d2cf768112a08cd885d","parents":["fb4cadc9cb9813a986650a758657034a10fc4cc1"],"ref":"refs/changes/89/3289/4","uploader":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"createdOn":1518114239,"author":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1518114313,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1518114684,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1518114684,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/sdcadm.js","type":"MODIFIED","insertions":24,"deletions":-2}],"sizeInsertions":24,"sizeDeletions":-2},{"number":"5","revision":"0587a0a0575c2c1e26db8fd60da9c3d26952790d","parents":["fb4cadc9cb9813a986650a758657034a10fc4cc1"],"ref":"refs/changes/89/3289/5","uploader":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"createdOn":1518126849,"author":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1518114313,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1518114684,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1518114684,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1518126857,"by":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/sdcadm.js","type":"MODIFIED","insertions":24,"deletions":-2}],"sizeInsertions":24,"sizeDeletions":-2}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}]}